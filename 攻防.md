### 攻防复习

主要考核1-7章

单选

判断	5

问答	35（5 * 7）

​	名词 术语

分析	45  (15 * 3）

​	综合论述 非标

非标 ： 威胁模型 常见的模型：攻击链、钻石模型……

chap1 攻击概述	简单题目

chap2 信息收集	2.5了解（不考太多）

chap3 了解 常识

chap4 import 缓冲区原理 什么情况出错 利用 shellcode编码汇编代码分析

反汇编了解

chap5 sql&xss源码分析 防御措施 代码中漏洞 利用payload

chap6 恶意代码区别、特点、木马隐藏技术

chap7 重点 网络 分析场景 多看

​	协议差异性 攻击类型 arp

chap8.9（选择填空）

以后基本不考

问答、综合分析 条理、分点

分析 结合实际场景

才140页

原理、案例分析、代码分析、作业

------

ch1 

常见攻击步骤及方法

获取信息 提升权限 安装后门 扩大影响 清楚痕迹

ch2

信息收集、没有无用的信息

主机、端口扫描

常见的ICMP报文3xx|4xx|5xx

常见端口 20|21|23|25……

端口扫描与隐秘扫描|SYN扫描

TCP/IP协议栈指纹

漏洞扫描：主动式策略(基于网络)被动式策略(基于主机)

漏洞检测的主要方法：直接测试、推断、带凭证测试

漏洞扫描软件：ISS、SATAN、**Nessus**

------

## ch4 缓冲区溢出

漏洞分类：

- 针对security OS
- 安全漏洞+软件错误
- mult 
- 广义
- 抽象...???

漏洞攻击步骤：漏洞发现->漏洞分析->漏洞利用

可能的后果：提权、远程拒绝服务攻击

标准化研究：CVE、CWE

典型漏洞类型：栈溢出、堆溢出、格式化串、整型溢出、释放再使用

栈溢出原理：程序运行时，计算机会在内存中开辟一段连续内存block，include 代码段、数据段、堆栈段

![image-20210102142615271](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210102142615271.png)

堆栈段：先堆后栈||Heap在.bss上，存储程序运行时非配得变量，new、malloc()、delete、free()

栈：储存函数调用时的临时信息的结构，传的参数、返回地址、局部变量等...需要时分配不需要自动清除||栈->先进后出(FILO)||push()/POP()

**随着调用层数增加，函数栈帧向低地址方向延伸**

**随着调用减少，各种函数返回后，栈帧会向高地址回缩**

**溢出中主要关注数据区和堆栈区**

使用栈的栈帧主要通过两个寄存器：SP、BP

SP：栈顶指针，有数据入栈就变化

BP：基地址指针，用于标识栈中一个相对稳定的地址，BP+偏移指针就可以引用函数参数地址和局部变量

![image-20210102144725871](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210102144725871.png)

***局部变量下面时前一个调用的EBP、接下来是返回地址***

***如果局部变量发生溢出，可能会覆盖掉EBP甚至RET***

如果在堆栈中压入的数据超过预先给堆栈分配的容量时，会出现堆栈溢出，使得程序运行失败or系统崩溃

------

函数调用的流程：

1. 首先把指令寄存器EIP(指向CPU运行的下一条指令的地址)中的内容压栈作为返回的地址(RET)
2. 随后放入栈EBP，指向当前函数栈帧底部
3. 然后把当前栈指针ESP拷贝到EBP，作为新的基址，把ESP减去适当的数值

溢出漏洞利用原理：

- 溢出攻击的基本流程：
  - 注入恶意数据->溢出缓冲区->控制流重定向->执行有效荷载
- 溢出利用的关键技术：
  - 溢出点定位
  - 覆盖执行控制地址
  - 覆盖异常处理结构
  - 跳转地址的确定
  - Shellcode定位和跳转

溢出点定位：探测(构造数据，根据报错信息判断)/反汇编分析

覆盖执行控制地址：包括返回地址/函数指针变量/异常处理结构(出现异常时会系统中断，由异常处理程序来处理)

跳转地址确定：指令选择(jmp esp/call ebx/call ecx……)||搜索范围：用户空间任意地址、系统dll、代码段、PEB、TEB

shellcode：一段能够完成一定功能、可直接由计算机执行的机器代码，通常是十六进制

shellcode功能：alert/dos/添加admin用户/打开端口进行远程连接/发起反向连接/up(down)load木马/等

编写一个shellcode：编写c语言程序，汇编查看

Win函数调用原理：LOAD动态链接库(dll)->使用堆栈传参->CALL 地址

通用shellcode编写方法：针对不同版本的OS使用不同的函数地址

OR

动态定位函数地址GetProcAddress和LoadLibrary函数获取其他函数的地址

↓

如何获得上述函数的地址？

暴力搜索(函数在kernel32.dll中，so在内存中找kernel32.dll库！！不通用)||PEB获取||SHE获取kernel基址||HASH法查找所有函数地址

通过TEB找到PEB，fs寄存器指向TEB结构，TEB+0x30指向PEB，PEB+0x0c指向PEB_LDR_DATA结构，PEB_LDR_DATA+0x1C就是动态链接库的地址，第二个是kernel32.dll

![image-20210102164651053](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210102164651053.png)

kernel32.dll基址+0x3c+0x78->引出表，可以查找相应的函数名和地址

SHE获得kernel基址：通过搜索异常链找到UnhandleExceptionFilter函数->找到kernel基址

HASH法查找所有函数地址

Windows异常处理

在程序中内嵌一段代码，用来处理在程序中抛出的异常

异常处理链表：SEH记录

- 基于帧异常处理例程信息将以exception_registration结构储存在栈中
- 大小为8字节，两个(4 byte)成员

覆盖默认异常处理SEH：

![image-20210103114201990](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103114201990.png)

处理过程中先找到fs:[0]的地址，这个地址存放上一层异常链指针，这个地方+4存着处理函数的地址，OS跳转到这执行函数，如果无法处理则再向上寻找

当链表中所有的异常处理函数都无法处理时，系统使用默认异常处理指针来处理异常you情况

负责显示一个错误对话框

堆溢出：

堆时一种物理结构，用来动态分配、释放对象，适合用在事先不知道程序所需对象的数量和大小的情况下，heap

堆，实在可执行程序的heap区，从低地址向高地址扩展，存放malloc等函数动态分配数据的地方

![image-20210103115514752](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103115514752.png)

堆分为堆表和堆块

堆表：一半位于堆的起始位置，索引堆区中所有堆块的信息，eg：位置大小空闲状态等

堆块：出于性能考虑堆的内存按不同大小组指成块，以堆块为单位进行标识，堆块包括块首和块身

win中，占用态的堆块被程序索引，堆表仅索引所有空闲态的堆块

most important 空闲双向链表FreeList(空表)和快速单向链表Lookaside(块表)

堆块的结构：

- 块首时一个堆块头部的几个字节，用来标识自身信息
- 块身时跟在块首后面的部分，也是分配给用户使用的数据区

堆管理系统所返回的指针一般指向块身的起始位置

块首的结构

![image-20210103121217210](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103121217210.png)

堆的基本操作

可以分为：堆块分配、堆块释放、堆块合并，分配和释放是在程序提交申请和执行的，合并是由堆管理系统自动完成

堆块分配：快表分配、普通表分配和零号空表

释放堆块：将堆块状态改为空闲，链入相应的堆表，所有释放块都链入堆表的末尾，分配也从堆表末尾拿

合并包括将两个块从空闲链表中卸下，合并，调整合并后大块的块首信息、将新快重新链入空闲链表

------

堆溢出的利用——DWORD　SHOOT

通过构造数据去溢出下一个堆块的块首,改写块首中的前后指针,随后就可以在发生堆操作的时候获得一次向内存任意地址写入任意数据的机会

代码植入:

- 内存变量
- 代码逻辑
- 函数返回地址
- 攻击异常处理机制
- 函数指针
- P.E.B中线程同步函数的入口地址

定位溢出点:生成字符串->调试程序->查询溢出字符

跳转到shellcode:

后门shellcode编写：

客户端和服务端编写

管道：PIPE简单的进程间通信IPC机制，一个进程往管道中写入数据，一个进程从管道中读取数据

分为：命名管道和匿名管道

命名管道：同一机器不同进程和不同机器的不同进程间双向通信

匿名管道：仅在父子进程或一个进程的两个子进程间单向通信 

- 使用 创建子进程，设置为继承->往管道中写数据->检查管道中是否有数据->从管道中读数据

后门总体思路：

模式：

- 两个匿名管道(目标机中，父子进程间)
- 一个匿名管道(目标机中，父进程以命令向子进程发送，子进程通过管道返回结果)
- 无管道(父子进程间SOCKET)

shellcode编码：

为什么编码?避免shellcode被截断(避免出现\x00)||符合目标程序的要求、避免IDS、杀软检测

如何检查Exploit利用是否失败?

​	shellcode最前加上\xEB\xFE => JMP -1造成死循环=>查看调试器

异或法：异或的异或和原来一样

编码：异或97

解码：decode程序

微调法：在不改变指令功能的情况下个别改变代码(等价边换)

直接替换法

字符拆分法：Z=A+B

​		   0xAB=0xA * 0x10 + 0xB

内存搜索法：针对：shellcode长度有限制

​		   原理：?

------

## ch5 web应用攻击

basic：web服务器(web网页、SQL)||WEB客户端||HTTP协议

主流Web服务器：Apache、Nginx、IIS(微软)等

web应用攻击类型：

- web客户端攻击:
  - 跨站脚本攻击XSS、网络钓鱼、网页挂马
- web服务器攻击
  - 网页篡改、代码注入攻击、文件操作控制攻击
- web服务器攻击
  - HTTP头注入攻击、HTTP会话攻击

XSS：Cross-Site SCripting

由于Web应用程序对用户输入过滤不足而产生的，使得攻击者输入的特定数据变成了JavaScript脚本或者HTML代码

同源策略：A网页的Cookie，B网页不能打开，除非同源

同源☞协议相同||域名相同||端口相同

XSS是OWASP TOP10中第二普遍的安全问题，自动化工具能发现一些XSS问题，尤其是成熟的技术中，PHP、J2EE或JSP、ASP.NET

流行原因：web浏览器本身的安全问题||in&output是web程序最基本的交互，过程中没有好的安全防护||开发人员问题||没有XSS漏洞意识||XSS触发简单，防御困难||web2.0流行有更多XSS的舞台

XSS危害：

1. 网络钓鱼，盗号
2. 窃取用户cookies资料，获取隐私信息，利用好用户身份对网站进行操作
3. 劫持用户会话，执行任意操作，eg：非法转账、日志、发送邮件
4. 强制弹出网页广告、刷流量
5. 网页挂马
6. 恶意操作，篡改页面信息、删除文章
7. 大量的客户端攻击，eg：DDoS
8. 提取客户端信息，浏览历史、真实IP、端口
9. 控制受害者机器发起攻击
10. 结合其他漏洞，eg：CSRF
11. 提权，进一步渗透
12. 传播跨站脚本蠕虫

XSS类型：反射性XSS||存储型XSS||DOM XSS

反射型XSS：非持久性、参数型跨站脚本、恶意脚本附加到URL地址参数中

技巧：隐藏网址内容

储存型XSS：持久型||一般攻击存在留言、日志等中||恶意代码被储存在服务端的数据库中

DOM型XSS：基于js|| 不需要与服务端交互||网站有个HTML采用不安全的方式

cookie窃取：![image-20210103155809363](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103155809363.png)

会话劫持：会话ID由客户端给服务器表示同一个会话，一般用cookie或URL传递，保存在服务器，劫持利用XSS，毛用合法的ID进行访问

钓鱼：

信息刺探：XSS可以在客户端执行JS代码，因此可以进行收集信息

网页挂马：将恶意脚本隐藏在Web中，浏览网页时就下载启动木马程序

XSS蠕虫：一般利用储存型XSS将jS代码保存在服务器上，其他用户浏览时执行JS代码，引发攻击

XSS防范措施：HttpOnly禁止任何脚本访问cookie内容

​		    安全编码：<>&"'进行转码

SQL Injection 

SQL：结构化查询语言，一种用来和数据库交互的查询语言

常见数据库：oracle、sybase、sql server、access

数据库=>表的集合=>由行和列组成

select	where通配符：%任意类型长度(中文double %%)	_单个任意字符	[]一个字符字符串或范围

联合查询

sql注入类型：字符型、数字型、基于错误信息的SQL注入、SQL盲注

SQL注入步骤：

1. 发现注入点：用'"等测试，看错误提示
2. 数据库类型判断，根据特征
3. 构造sql语句原型：创造一个联合或者永真+or
4. 猜解表名字段名
5. 猜字段值

工具：Nbsi、明小子

6.获取用户名密码后，登陆后台，上传asp木马、一句话木马、图片马等<%eval(request("#"))%>

eval会执行括号内的东西

提权：eg：webshell、nc

SQL 注入危害：

- 读取、修改删除数据库内数据，获取用户名密码等数据
- 获取sql管理员权限
- 进而获得系统权限
- SQL隐蔽性：从WWW端口访问，防火墙不易发现

暴库：通过一些技术得到数据库地址，将数据下载

Google hack、%5c暴库

SQL注入防范措施：

- 特殊字符转义
- 输入验证和过滤
- 参数化方法

HTTP会话攻击和防御：

HTTP协议设计之初没有考虑会话问题，现在的Web应用基本都有会话

后来增加的会话管理天生不足，一直在更新

经典的HTTP会话攻击技术有：预测会话ID、窃取会话ID、控制会话ID、CSRF

防范措施：

- 针对预测会话ID攻击：建议用编程语言内置的会话管理机制eg：PHP、JAVA
- 针对窃取会话ID号攻击：基于XSS则采用HttpOnly
- 针对会话ID固定攻击：采用非会话采纳的Web环境或对会话采纳方式防范
- 针对会话保持攻击：不让ID号长期有效
- 针对CSRF：
  - 使用POST代替GET
  - 检验HTTP referer
  - 验证码
  - Token

------

## ch6 恶意代码

恶意代码功能：删除敏感信息、作为网络传播的起点、监视键盘、收集信息、获取屏幕、shell上执行命令、窃取文件、开启后们、隐藏活动

![image-20210103164520727](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103164520727.png)

病毒生命周期：潜伏、传染、触发、发作

特征：![image-20210103165220123](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103165220123.png)

病毒程序：传染机制、触发机制、破坏机制

病毒的触发机制：

时间、日期||键盘触发||感染出发||启动触发||磁盘访问和中断访问触发||其他(OS型号、IP、语言、地区)

破坏机制：攻击系统数据区：主引导扇区、Boot扇区、FAT表和文件目录||攻击文件和硬盘：删除该命替换内容、等||攻击内存：占用大量内存、改变内存总量、蚕食内存等

![image-20210103165924539](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103165924539.png)

传播机制：移动存储、网络访问、Email、局域网、盗版软件、共享PC、修理

------

蠕虫：自身具有完整性和独立性

![image-20210103170233797](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103170233797.png)

why 蠕虫：技术||接管大量系统||追踪困难||DDoS

行为特征：主动攻击||行踪隐蔽||利用OS、网络服务漏洞||造成网络拥塞||降低系统性能||安全隐患||反复/破坏性

组成：![image-20210103170437875](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103170437875.png)

工作流程：![image-20210103170656563](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103170656563.png)

移动恶意代码

后门：允许攻击者绕过系统中常规安全控制机制

​	安装：自己植入||病毒、蠕虫、移动恶意代码、自己安装

无端口后门：ICMP后门、非混合型探测后门、混合型探测后门

特洛伊木马：<img src="C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103172211616.png" alt="image-20210103172211616" style="zoom:150%;" />

![image-20210103172743814](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103172743814.png)

木马基本特性：自启动、功能、抗查杀、隐蔽性

特洛伊木马的检测与防范：

利用开放主机端口号和各个木马程序使用端口的对应关系，判断主机是否已中木马，根据中木马的类型，对其中的部分进行杀灭，用户可自行追加数据库，增加能查找病毒的种类

------

## ch7 假消息攻击

chap7 重点 网络 分析场景 多看

​	协议差异性 攻击类型 arp

假消息攻击：是利用网络协议设计中的安全缺陷，通过发送伪造的数据包达到欺骗目标获利的目的

TCP/IP缺陷：缺乏有校的信息加密，易被截获

​		    缺乏有效的身份鉴别和认证机制，双方无法确认彼此身份

![image-20210103175917359](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103175917359.png)

嗅探

范围：802.3以太网，使用广播信道的网络

以太网：共享式以太网(使用同轴电缆或HUB连接)和交换式以太网(使用交换机连接)

工作原理：从网络中接收数据，处理完数据链路层的任务后向OS传递

​		网卡接收到传输来的消息，网卡内的单片程序检查数据帧的目的MAC，根据驱动模式的接收模式决定是否接收(不接就丢弃，否则通过中断告知OS)

以太网卡的侦听模式：侦听模式是网络适配器分析传入帧的目标MAC

- 单播模式：接收单播和广播数据帧
- 组播模式：接收单播和广播和组数据组帧
- 混杂模式：接收所有数据帧

单播下，网卡只让MAC与自己MAC相同的数据帧或广播帧过，过滤其他

混杂下，接收所有通过它的数据，不进行目的地址检查

交换式以太网：使用交换机组建的局域网||使用端口和MAC地址对应表进行数据转发，根绝包的目标MAC选择端口

MAC洪泛：发送大量虚构MAC和IP的包，使得无法处理，进入打开失效模式，类似HUB，向所有机器广播数据包

MAC欺骗：将源MAC未造成主机的源MAC通过交换机发送，让其更新MAC-端口映射表

ARP欺骗：通过对网关和目标主机进行ARP欺骗，可以截取到两者之间的数据

协议还原：就是将离散的网络数据根据协议规范还原成可读的协议格式

- 主机封包、嗅探器抓包、嗅探器组包

MAC帧头|IP包头|TCP包头|应用层data

数据链路层|网络层|传输层|应用层

802.3|ICMP、IP|TCP、UDP|HTTP、FTP、SMTP、POP3

主机封包：将应用层，封装为网络层

![image-20210103181608230](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103181608230.png)

嗅探器组包相反

检测嗅探：发送可以触发OS响应，又不通过硬件过滤的数据包就可以检测主机网络接口的接收模式，这种包应该有特殊的MAC

防范嗅探：

- 网络分段
  - 用交换机代替集线器
  - 划分VLAN
- 会话加密
  - 安全协议
- 静态ARP缓存

ARP欺骗

ARP协议作用：IP地址=>ARP协议=>物理地址

ARP缓存：ARP请求是广播包

How to ARP欺骗：ARP请求发送错误的发送者IP-MAC

​			   ARP应答中发用错误的发送者IP-MAC

ARP欺骗危害：拒绝服务攻击|嗅探|中间人攻击

ARP欺骗防范：

- 建立DHCP服务器
- 局域网中建立MAC数据库
- 网关关闭ARp动态刷新过程，用静态路由
- 局域网监听ARP包
- 用VLAN或PVLAN

------

ICMP重定向攻击

![image-20210103182653007](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103182653007.png)

ICMP重定向报文：主机启动时有一定的路由信息，非最优|路由检测到IP数据包经非最优路由传输，就通知主机最优路径

​	功能：保证主机有动态、最小且优的路由表

![image-20210103183349383](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103183349383.png)

ICMP重定向攻击危害

- 改变对方路由表
- ICMP类似ARP也可做拒绝服务、嗅探或中间人攻击

ICMP重定向的条件

- 新路由直达
- 重定向包必须来自去往目标的当前路由
- 重定向包不能通知主机用自己做路由
- 被改变的是间接路由

ICMP防范：

- 配置防火墙，拒绝ICMP重定向报文
- Linux可以防火墙上拒绝或者修改内核选项重新编译内核来拒绝
- Win下通过防火墙和IP策略拒收ICMP报文

IP欺骗：需要伪造IP头部的源IP地址

难点：得到TCP的ACK初始序列号

危害：以可信任的身份与服务器建立连接||伪造源IP，隐藏身份，消除攻击痕迹

防范：![image-20210103183919263](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103183919263.png)

DNS欺骗

原理：拦截DNS服务器响应包，修改后返回

难点：标识号ID

危害：用户访问合法重定向到另一个网站

​	 不知情下访问恶意网站

防范：静态域名-IP映射

​	  直接用IP地址连接服务器

SSl中间人攻击

MITM中间人攻击

![image-20210103184840807](C:\Users\49353\AppData\Roaming\Typora\typora-user-images\image-20210103184840807.png)

防范：仔细查看证书来源和属性

不要打开证书来源不可信的网址

